{% extends "layout.html" %} {% block main %}

<div id="create_list_container" class="container w-75 mx-auto">
  <h2>{{page_title}}</h2>
  <form action="/create_list" method="post" data-list="{{preloaded_list.cards}}" id="create_list_form" class="align-items-end">
    <div class="cards_number_tracker">
    </div>
    <div class="list w-100">
      <input
        type="hidden"
        id="list_id"
        name="id"
        value={{preloaded_list.id}}
      />
      <input
        type="text"
        id="list_title"
        class="form-control rounded-2"
        name="title"
        placeholder="Title"
      />
      <textarea
        name="description"
        id=""
        class="form-control rounded-2 my-2"
        rows="3"
        placeholder="Add a description"
      >{{preloaded_list.description}}</textarea>
    </div>
    <div class="cards-group w-100"></div>

    <button class="btn add-card w-auto mx-auto rounded-pill border-2" type="button"><i class="bi bi-plus"></i> Add one card</button>
    <button class="btn btn-primary import-list w-auto mx-auto rounded-pill border-2" type="button"><a href="/import_list" class="text-light text-decoration-none"><i class="bi bi-upload"></i> Import a csv file</a></button>

    <button type="submit" class="btn create-list-btn w-25 mt-5 rounded-pill border-2 float-end">{{button_text}}</button>
  </form>
</div>

{% endblock %} {% block script %}
<script>

/**
 * Flashcards List Editor
 * Handles creating, deleting, and editing flashcards dynamically.
 * Preloads existing cards if available.
 */

  let cards = [
    {
      term: "",
      definition: "",
    },
    {
      term: "",
      definition: "",
    },
  ];

  const preloadedList= {{ preloaded_list | tojson | safe }};

  let cardsGroupContent = ``;

  const form = document.querySelector("form")

  const addCardButton = document.querySelector(".add-card");

  const cardsGroup = document.querySelector(".cards-group");

  const cardsNumberTracker = document.querySelector(".cards_number_tracker");

  let termInputs = document.querySelectorAll(".term-input");
  let definitionInputs = document.querySelectorAll(".definition-input");

  // If editing an existing list, populate title and cards from preloaded data

  if(preloadedList.hasOwnProperty("title")) {
    document.getElementById("list_title").setAttribute("value", preloadedList.title)
  }


  // Re-select input fields and attach keyup listeners to update cards array

  const checkInput = () => {
    termInputs = document.querySelectorAll(".term-input");
    definitionInputs = document.querySelectorAll(".definition-input");

    termInputs.forEach((termInput, i) => {

      termInput.addEventListener("keyup", (e) => {
        cards[i].term = termInput.value;
      });
    });

    definitionInputs.forEach((definitionInput, i) => {

      definitionInput.addEventListener("keyup", (e) => {
        cards[i].definition = definitionInput.value;

      });
    });
  };

  // Clear the current cards group
  // If editing an existing list, use preloaded cards
  // For each card, generate HTML and insert it into the DOM
  // Update hidden input tracking the number of cards

  const renderCards = () => {
    cardsGroup.innerHTML = "";

    if(preloadedList.hasOwnProperty("cards")) {
      cards = preloadedList.cards
    }

    cards.forEach((card, i) => {
      const index = i + 1;

      const cardHTML = `
      <div class="card rounded-4 my-4" id="card_${index}">
        <div class="card-header d-flex justify-content-between rounded-top-4  pt-3 pb-4 px-3">
          <div class="card-title card-number"><h4">${index}</h4></div>
          <button class="btn btn-outline-light delete-card rounded-circle py-0 px-1" data-index="${i}">
            <i class="fa-solid fa-trash-can d-flex align-center justify-content-center"></i>
          </button>
        </div>
        <div class="card-container px-3">
          <div class="inputs row py-4">
            <div class="form-group col d-inline-flex flex-column">
              <input type="text" class="form-control term-input rounded-2 w-100"
                     name="term_card_${index}" value="${card.term}" />
              <label for="term" class="mt-1">Term</label>
            </div>
            <div class="form-group col d-inline-flex flex-column">
              <input type="text" class="form-control definition-input rounded-2 w-100"
                     name="definition_card_${index}" value="${card.definition}" />
              <label for="definition" class="mt-1">Definition</label>
            </div>
          </div>
        </div>
      </div>
    `;
      cardsGroup.insertAdjacentHTML("beforeend", cardHTML);
    });

    cardsNumberTracker.innerHTML = `<input type="hidden" name="cards-number" value="${cards.length}">`;
    checkInput();
  };

  // Ensure there are always at least two cards in the list

  const checkCardsListLength = () => {
      
      if(cards.length <= 2) {
          const deleteButtons = document.querySelectorAll(".delete-card")
          
          deleteButtons.forEach(button => {
              button.setAttribute("disabled", "");
            })
        }
    }
  
  // Remove the term from the list and adjust the term's number to avoid gap

  cardsGroup.addEventListener("click", (e) => {
    const btn = e.target.closest(".delete-card");
    if (!btn) return;

    const index = parseInt(btn.dataset.index, 10);
    cards.splice(index, 1);
    renderCards();
    checkCardsListLength()
  });

  // Add a new empty card to the list and re-render

  addCardButton.addEventListener("click", () => {

    cards.push({ term: "", definition: "" });
    renderCards();
    checkCardsListLength()
  });

  renderCards();
  checkInput();
  checkCardsListLength()

</script>
{% endblock %}
